#!/bin/bash

# Set all variables with pre-filled values
SUBSCRIPTION="4646d76f-5ac7-47c6-93a3-d0110c1da84a"
RESOURCE_GROUP="ClickUP_API"
LOCATION="centralus"
APP_NAME="clickup-api"
ENVIRONMENT_NAME="managedEnvironment-ClickUPAPI"
GITHUB_USERNAME="bismillahtechai"
GITHUB_TOKEN="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"
IMAGE="ghcr.io/bismillahtechai/clickup-typingmind-integration:1.0.0"

# Generated secure keys (pre-generated for convenience)
API_KEYS="9d7f6e21c8a3b457109082e5fd6c413a"
TOKEN_ENCRYPTION_KEY="5b8f2a36c1d907e4582fd396b0e8c741"

# ClickUp API token - YOU MUST REPLACE THIS with your actual ClickUp API token
CLICKUP_API_TOKEN="pk_126180892_EXPM36WLKVES0RVFQ2U2LPV8T3NZ3BWI"

# Set subscription
az account set --subscription $SUBSCRIPTION

# Create resource group if it doesn't exist
az group create --name $RESOURCE_GROUP --location $LOCATION

# Create Container App Environment
az containerapp env create \
  --name $ENVIRONMENT_NAME \
  --resource-group $RESOURCE_GROUP \
  --location $LOCATION

# Create Container App
az containerapp create \
  --name $APP_NAME \
  --resource-group $RESOURCE_GROUP \
  --environment $ENVIRONMENT_NAME \
  --image $IMAGE \
  --registry-server "ghcr.io" \
  --registry-username $GITHUB_USERNAME \
  --registry-password $GITHUB_TOKEN \
  --env-vars "PORT=3000" "NODE_ENV=production" "API_KEYS=$API_KEYS" "CLICKUP_API_TOKEN=$CLICKUP_API_TOKEN" "TOKEN_ENCRYPTION_KEY=$TOKEN_ENCRYPTION_KEY" "MAX_TASKS_LIMIT=100" \
  --target-port 3000 \
  --ingress external \
  --min-replicas 1 \
  --max-replicas 3

# Get the deployed URL
APP_URL=$(az containerapp show --name $APP_NAME --resource-group $RESOURCE_GROUP --query properties.configuration.ingress.fqdn -o tsv)

echo "=========================================================================="
echo "DEPLOYMENT COMPLETE!"
echo "=========================================================================="
echo "Your Container App is deployed at: https://$APP_URL"
echo ""
echo "IMPORTANT: Save these details for TypingMind configuration:"
echo "------------------------------------------------------------------------"
echo "URL for TypingMind: https://$APP_URL/context/clickup"
echo "API Key: $API_KEYS"
echo "Example full URL: https://$APP_URL/context/clickup?workspaceId={WORKSPACE_ID}&dataType=tasks&limit=10&api_key=$API_KEYS"
echo "=========================================================================="